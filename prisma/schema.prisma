// =============================================================================
// Blink Engine - Prisma Schema
// =============================================================================
// This is your Prisma schema file. Learn more at: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// User & Authentication
// =============================================================================

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  passwordHash     String
  name             String
  surname          String
  phoneNumber      String?
  profileImageUrl  String?
  isPremium        Boolean   @default(false)
  isPhoneValidated Boolean   @default(false)
  isEmailValidated Boolean   @default(false)
  isTracking       Boolean   @default(false) // Global "Live Location" switch
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  refreshTokens RefreshToken[]
  contacts      Contact[]
  locations     Location[]
  sosEvents     SosEvent[]

  @@index([email])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)
  family    String   // Token family for rotation tracking

  @@index([token])
  @@index([userId])
  @@index([family])
  @@map("refresh_tokens")
}

// =============================================================================
// Emergency Contacts
// =============================================================================

/// Contact status enumeration
/// - pending: Invitation sent, waiting for response
/// - accepted: Contact has accepted the invitation
/// - declined: Contact has declined the invitation
model Contact {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactUserId String? // Link to the actual User record of the contact
  name          String
  phoneNumber   String
  email         String?
  isPrimary     Boolean  @default(false)
  status        String   @default("accepted") // Default to accepted as we now use Invite flow
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@map("contacts")
}

/// Contact Invitation logic
/// - pending: Waiting for receiver to respond
/// - accepted: Receiver accepted, contacts created
/// - declined: Receiver declined
model ContactInvite {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  status     String   @default("pending") // pending, accepted, declined
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([receiverId]) // Receiver polls for these
  @@index([senderId]) // Sender polls for status updates
  @@index([status])
  @@map("contact_invites")
}

/// Short-lived invite codes for secure contact adding
/// - Users generate a 6-character code that expires after 5 minutes
/// - Other users can scan the QR code or enter the code manually
/// - Once used, the code is marked as used and cannot be reused
model InviteCode {
  id        String    @id @default(cuid())
  code      String    @unique
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([code])
  @@index([userId])
  @@index([expiresAt])
  @@map("invite_codes")
}

// =============================================================================
// Location Tracking
// =============================================================================

model Location {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  latitude  Float
  longitude Float
  accuracy  Float?
  altitude  Float?
  speed     Float?
  heading   Float?
  timestamp DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
  @@index([userId, timestamp])
  @@map("locations")
}

// =============================================================================
// SOS Events (Safety-Critical)
// =============================================================================

/// SOS Event status enumeration
/// - active: SOS is currently active, contacts being notified
/// - resolved: SOS was resolved (user confirmed safety)
/// - cancelled: SOS was cancelled by user
/// - expired: SOS expired without resolution
model SosEvent {
  id               String    @id @default(cuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  triggeredAt      DateTime
  cancelledAt      DateTime?
  resolvedAt       DateTime?
  latitude         Float
  longitude        Float
  status           String    @default("active") // active, resolved, cancelled, expired
  notifiedContacts Json?     // Array of contact IDs that were notified
  auditLog         Json?     // Audit trail of all actions
  idempotencyKey   String?   @unique // For idempotent triggers
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([userId, status])
  @@index([triggeredAt])
  @@map("sos_events")
}

// =============================================================================
// Audit Log (For Safety-Critical Operations)
// =============================================================================

model AuditLog {
  id            String   @id @default(cuid())
  userId        String?
  action        String   // e.g., "SOS_TRIGGERED", "SOS_CANCELLED", "CONTACT_NOTIFIED"
  resourceType  String   // e.g., "SosEvent", "Contact"
  resourceId    String?
  metadata      Json?
  ipAddress     String?
  userAgent     String?
  correlationId String?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([correlationId])
  @@index([createdAt])
  @@map("audit_logs")
}

// =============================================================================
// Security Network (Placeholder / Future)
// =============================================================================

model SecurityNode {
  id          String   @id @default(cuid())
  name        String
  company     String
  latitude    Float
  longitude   Float
  status      String   // e.g., "patrolling", "active", "dispatched"
  eta         String?  // Mock ETA for now
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("security_nodes")
}
